version: "3.8"

networks:
  sandbox:
    driver: bridge

volumes:
  esdata01:
    driver: local
  pgdata01:
    driver: local

services:
  es01:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.3
    container_name: rda-elasticsearch
    labels:
      co.elastic.logs/module: elasticsearch
    networks:
      - sandbox
    volumes:
      - esdata01:/usr/share/elasticsearch/data
    ports:
      - "127.0.0.1:9200:9200" # CHANGED: localhost only
    environment:
      - node.name=es01
      - cluster.name=docker-cluster
      - discovery.type=single-node
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-El@st1c!Str0ngP@ss2025#}
      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - xpack.security.enabled=true # CHANGED: security enabled
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - xpack.license.self_generated.type=basic
      - http.cors.enabled=true
      - http.cors.allow-origin="http://localhost:3000" # CHANGED: specific origin only
      - http.cors.allow-methods=GET,POST,PUT,DELETE,OPTIONS,HEAD
      - http.cors.allow-headers=X-Requested-With,X-Auth-Token,Content-Type,Content-Length,Authorization
    deploy:
      resources:
        limits:
          memory: 2g
        reservations:
          memory: 1g
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s -u elastic:$${ELASTIC_PASSWORD:-El@st1c!Str0ngP@ss2025#} http://localhost:9200 | grep -q 'You Know, for Search'",
        ]
      interval: 10s
      timeout: 10s
      retries: 120
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres_database:
    image: postgres:17-alpine
    container_name: rda-postgres-database
    restart: unless-stopped
    networks:
      - sandbox
    ports:
      - "127.0.0.1:${DATABASE_PORT:-5432}:5432" # CHANGED: localhost only
    volumes:
      - pgdata01:/var/lib/postgresql/data
    shm_size: 128mb
    environment:
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-Pg!S3cur3P@ssw0rd2025#RDA} # CHANGED: strong password
      POSTGRES_USER: ${DATABASE_USERNAME:-postgres}
      POSTGRES_DB: ${DATABASE_NAME:-rda_gateway}
    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 256m
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DATABASE_USERNAME:-postgres} -d ${DATABASE_NAME:-rda_gateway}",
        ]
      interval: 10s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
